<?php
    require_once 'login.php';
    $conn = new mysqli($hn, $un, $pw, $db);
    if($conn->connect_error) die($conn->connect_error); //Use more user-friendly error code from Lecture 14: "Connecting to a MySQL Database"

    echo <<<_END
        <html>
            <head>
                <title>setupusers</title>
            </head>
        </html>
_END;

    $queryUsers = "CREATE TABLE IF NOT EXISTS users(username VARCHAR(128) NOT NULL UNIQUE, password VARCHAR(128) NOT NULL UNIQUE, forename VARCHAR(25) NOT NULL, surname VARCHAR(25) NOT NULL, admin BOOLEAN DEFAULT FALSE, id BIGINT UNSIGNED NOT NULL  AUTO_INCREMENT PRIMARY KEY)";

    $resultUsers = $conn->query($queryUsers);
    if(!$resultUsers) die("Database access failed: ". $conn->error);

    //Describing user table
    echo "<br><br>Users:<br>";
    $queryDesU = "DESCRIBE  users";
    describe($queryDesU, $conn);

    function describe($query, $conn)
    {
        $result = $conn->query($query);
        if(!$result) die("Database access failed: ". $conn->error);

        $rows = $result->num_rows;
        echo "<table><tr><th>Column</th><th>Type</th><th>Null</th><th>Key</th></tr>";
        for($i = 0; $i < $rows; ++$i)
        {
            $result->data_seek($i);
            $row = $result->fetch_array(MYSQLI_BOTH);
            echo "<tr>";
            for($j = 0; $j < 4; ++$j) echo"<td>$row[$j]</td>";
            echo "</tr>";
        }
        echo "</table>";
    }

    $salt1 = "qm&h";
    $salt2 = "pg!@";

    $username = "adminEx";
    $password = "passwordEx";
    $forename = "Elana";
    $surname = "Olson";
    $admin = TRUE;
    $token = hash('ripemd128', "$salt1$password$salt2");

    add_user($conn, $username, $token, $forename, $surname, $admin, null);

    $username = "userEx";
    $password = "passEx";
    $forename = "Tanner";
    $surname = "Swenson";
    $admin = FALSE;
    $token = hash('ripemd128', "$salt1$password$salt2");

    add_user($conn, $username, $token, $forename, $surname, $admin, null);

    function add_user($conn, $username, $password, $forename, $surname, $admin, $id)
    {
        $query = "INSERT INTO users VALUES('$username', '$password', '$forename', '$surname', '$admin', '$id')";
        $result = $conn->query($query);
        if(!$result) die($conn->error);
    }

?>
